name: 'CI Tests'

on:
  push:
    branches: [ 'investigation/*' ]

jobs:
  fetch_static_secrets:
    runs-on: ubuntu-latest
    name: Fetch static secrets
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Fetch static secrets from AKeyless
      id: fetch-static-secrets
      uses: ./
      with:
        access-id: ${{ secrets.AKEYLESS_ACCESS_ID }}
        static-secrets: '{"/DevTools/my-static-secret":"my_static_secret"}'
        export-secrets-to-outputs: true
        export-secrets-to-environment: true
        
    - name: Verify static secrets output
      run: |
        echo "[static] Your output secret is ${{ steps.fetch-static-secrets.my_static_secret }}"
        echo "[static] Your environment secret is ${{ env.my_static_secret }}"

  fetch_dynamic_secrets:
    runs-on: ubuntu-latest
    name: Fetch dynamic secrets
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Fetch dynamic secrets from AKeyless
      id: fetch-dynamic-secrets
      uses: ./
      with:
        access-id: ${{ secrets.AKEYLESS_ACCESS_ID }}
        dynamic-secrets: '{"/DevTools/az-sqlsrvsecret":"my_dynamic_secret"}'
        export-secrets-to-outputs: true
        export-secrets-to-environment: true
        
    - name: Verify Environment Variables
      run: echo "[Env Var] Your environment secret is ${{ env.my_dynamic_secret }}"

    - name: Verify Job Outputs
      run: |
        echo "[Job Output] Your output secret is ${{ steps.fetch-dynamic-secrets.outputs.my_dynamic_secret }}"

        echo ${{ steps.fetch-dynamic-secrets.outputs.my_dynamic_secret }}["id"]
        echo ${{ steps.fetch-dynamic-secrets.outputs.my_dynamic_secret }}["user"]
        echo ${{ steps.fetch-dynamic-secrets.outputs.my_dynamic_secret }}["password"]
        echo ${{ steps.fetch-dynamic-secrets.outputs.my_dynamic_secret }}["ttl_in_minutes"]

        MY_DICT=${{ steps.fetch-dynamic-secrets.outputs.my_dynamic_secret }}
        echo $MY_DICT["id"]
        echo $MY_DICT["user"]
        echo $MY_DICT["password"]
        echo $MY_DICT["ttl_in_minutes"]

        MY_JSON=$(echo ${{ steps.fetch-dynamic-secrets-no-var.outputs.my_dynamic_secret }} | jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]')
        echo $MY_JSON["id"]
        echo $MY_JSON["user"]
        echo $MY_JSON["password"]
        echo $MY_JSON["ttl_in_minutes"]
